<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Private Chat</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#1e1f22;
  font-family:Arial;
  color:#dcddde;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.fade{animation:fade .3s}
@keyframes fade{from{opacity:0;transform:scale(.96)}to{opacity:1}}

.login,.settings{
  background:#313338;
  padding:20px;
  border-radius:8px;
  width:320px;
}
.login input,.settings input,button{
  width:100%;
  margin-top:8px;
  padding:8px;
}
button{background:#5865f2;color:white;border:none;cursor:pointer}

.app{
  width:1000px;height:560px;
  background:#313338;
  border-radius:10px;
  display:none;
  overflow:hidden;
}
.sidebar{
  width:260px;background:#2b2d31;padding:10px;
}
.chat{flex:1;display:flex;flex-direction:column}
.messages{flex:1;padding:10px;overflow-y:auto}
.msg{display:flex;margin-bottom:8px}
.msg img{width:36px;height:36px;border-radius:50%;margin-right:6px}
.input{display:flex;padding:10px;background:#383a40}
.input input{flex:1;background:#1e1f22;border:none;color:white;padding:8px}
.user{display:flex;align-items:center;margin-top:6px}
.user img{width:32px;height:32px;border-radius:50%;margin-right:6px}
.tag{color:#22c55e;font-size:12px}
.online{color:#22c55e}.offline{color:#ef4444}

.settings{
  position:absolute;left:20px;top:20px;display:none
}
.red{background:#ed4245}
.green{background:#22c55e}
</style>
</head>

<body>

<div class="login fade" id="loginBox">
  <h3>Login</h3>
  <input id="luser" placeholder="Username">
  <input id="lpass" type="password" placeholder="Password">
  <button onclick="login()">Daxil ol</button>
  <div id="loginMsg"></div>
</div>

<div class="app fade" id="app">
  <div class="sidebar">
    <b>Users</b> <span onclick="toggleSettings()" style="cursor:pointer">⚙️</span>
    <div id="userList"></div>
  </div>

  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="msg" placeholder="Mesaj yaz..."
        onkeydown="if(event.key==='Enter')sendMessage()">
      <button onclick="sendMessage()">Göndər</button>
    </div>
  </div>
</div>

<div class="settings fade" id="settings">
  <b>Ayarlar</b>

  <label>Tag (max 7)</label>
  <input id="tag">

  <label>Profil şəkli (URL)</label>
  <input id="avatarUrl" placeholder="https://...">

  <button onclick="togglePassword()">Şifrəni dəyiş</button>

  <div id="passBox" style="display:none">
    <input id="oldPass" type="password" placeholder="Köhnə şifrə">
    <input id="newPass" type="password" placeholder="Yeni şifrə">
  </div>

  <button class="green" onclick="saveSettings()">Yadda saxla</button>
  <button class="red" onclick="logout()">Çıxış</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC4t6Cu-q8iIHGy3V5g-Q14s3qnwsnfRKU",
  databaseURL:"https://projectchat-bcb6e-default-rtdb.firebaseio.com"
});
const db=firebase.database();

let user=null;

/* COOLDOWN */
let attempts=localStorage.getItem("attempts")?parseInt(localStorage.getItem("attempts")):0;
let cooldownUntil=localStorage.getItem("cooldownUntil")?parseInt(localStorage.getItem("cooldownUntil")):0;

/* AUTO LOGIN */
const saved=localStorage.getItem("user");
if(saved){
  db.ref("users/"+saved).get().then(s=>{
    if(s.exists() && !s.val().deleted){
      user=saved;
      start();
    }
  });
}

function login(){
  const now=Date.now();
  if(now<cooldownUntil){
    loginMsg.innerText=`⏳ ${Math.ceil((cooldownUntil-now)/1000)}s gözlə`;
    return;
  }

  db.ref("users/"+luser.value).get().then(s=>{
    if(!s.exists()||s.val().password!==lpass.value){
      attempts++;
      localStorage.setItem("attempts",attempts);
      if(attempts>=3){
        cooldownUntil=Date.now()+20000;
        localStorage.setItem("cooldownUntil",cooldownUntil);
        attempts=0;
      }
      return;
    }

    attempts=0;
    localStorage.removeItem("attempts");
    localStorage.removeItem("cooldownUntil");

    user=luser.value;
    localStorage.setItem("user",user);
    start();
  });
}

function start(){
  loginBox.style.display="none";
  app.style.display="flex";
  db.ref("users/"+user+"/online").set(true);
  users();
  messages();
}

function logout(){
  db.ref("users/"+user+"/online").set(false);
  localStorage.removeItem("user");
  location.reload();
}

function toggleSettings(){
  settings.style.display=settings.style.display==="block"?"none":"block";
}
function togglePassword(){
  passBox.style.display=passBox.style.display==="none"?"block":"none";
}

/* USERS */
function users(){
  db.ref("users").on("value",s=>{
    userList.innerHTML="";
    s.forEach(u=>{
      if(u.val().deleted) return;
      userList.innerHTML+=`
      <div class="user">
        <img src="${u.val().avatar||'https://i.imgur.com/6VBx3io.png'}">
        ${u.key} ${u.val().tag?`<span class="tag">(${u.val().tag})</span>`:""}
        <span class="${u.val().online?'online':'offline'}">●</span>
      </div>`;
    });
  });
}

/* CHAT */
function sendMessage(){
  if(!msg.value) return;
  db.ref("messages").push({user,text:msg.value});
  msg.value="";
}
function messages(){
  db.ref("messages").on("child_added",s=>{
    const m=s.val();
    messages.innerHTML+=`
    <div class="msg">
      <img src="https://i.imgur.com/6VBx3io.png">
      <div><b>${m.user}</b>: ${m.text}</div>
    </div>`;
  });
}

/* SETTINGS SAVE */
function saveSettings(){
  if(tag.value.length>7) return alert("Tag max 7");

  db.ref("users/"+user).get().then(s=>{
    if(passBox.style.display==="block"){
      if(oldPass.value!==s.val().password) return alert("Köhnə şifrə yanlışdır");
      if(newPass.value) db.ref("users/"+user+"/password").set(newPass.value);
    }

    db.ref("users/"+user+"/tag").set(tag.value);
    if(avatarUrl.value)
      db.ref("users/"+user+"/avatar").set(avatarUrl.value);

    settings.style.display="none";
  });
}
</script>

</body>
</html>
