<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Private Pro Chat</title>

<style>
body{
  margin:0;background:#1e1f22;font-family:Arial;color:#dcddde;
  height:100vh;display:flex;justify-content:center;align-items:center
}
.app{width:900px;height:520px;background:#313338;border-radius:8px;display:flex}
.sidebar{width:240px;background:#2b2d31;padding:10px}
.user{padding:6px;border-radius:4px;cursor:pointer}
.user:hover{background:#3f4147}
.online{color:#22c55e;font-size:10px}
.offline{color:#ef4444;font-size:10px}
.chat{flex:1;display:flex;flex-direction:column}
.messages{flex:1;padding:10px;overflow-y:auto}
.msg{margin-bottom:6px;display:flex;justify-content:space-between}
.trash{cursor:pointer;color:#ed4245}
.input{padding:10px;background:#383a40;display:flex}
.input input{flex:1;background:#1e1f22;border:none;color:#fff;padding:8px}
.input button{margin-left:8px;background:#5865f2;border:none;color:white;padding:8px 14px}
.login{
  width:300px;background:#313338;padding:20px;border-radius:8px
}
.login input{width:100%;margin-bottom:8px;padding:8px}
.login button{width:100%;padding:8px;background:#5865f2;border:none;color:white}
.adminPanel{border-top:1px solid #3f4147;padding-top:6px;margin-top:6px}
.adminPanel input,.adminPanel button{width:100%;margin-top:6px;padding:6px}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <h3>Login</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Daxil ol</button>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">

<div class="sidebar">
  <h4>Users</h4>
  <div id="userList"></div>

  <div class="adminPanel" id="adminPanel" style="display:none">
    <input id="searchUser" placeholder="User adƒ±">
    <button onclick="deleteUser()">User sil</button>
    <button onclick="toggleAdmin()">Admin ver / al</button>
  </div>
</div>

<div class="chat">
  <div class="messages" id="messages"></div>
  <div class="input">
    <input id="msg" placeholder="Mesaj yaz..."
      onkeydown="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">G√∂nd…ôr</button>
  </div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const CONFIG={
  adminUsername:"Huseyn(Qurucu)",
  firebase:{
    apiKey:"AIzaSyC4t6Cu-q8iIHGy3V5g-Q14s3qnwsnfRKU",
    databaseURL:"https://projectchat-bcb6e-default-rtdb.firebaseio.com"
  }
};

firebase.initializeApp(CONFIG.firebase);
const db=firebase.database();

let currentUser="", currentRole="user";

/* ===== LOGIN ===== */
function login(){
  const u=username.value.trim();
  const p=password.value.trim();

  db.ref("users/"+u).get().then(s=>{
    if(!s.exists()) return alert("User yoxdur");
    if(s.val().password!==p) return alert("Parol s…ôhv");

    currentUser=u;
    currentRole=s.val().role;

    db.ref("users/"+u+"/online").set(true);
    window.addEventListener("beforeunload",()=>{
      db.ref("users/"+u+"/online").set(false);
    });

    loginBox.style.display="none";
    app.style.display="flex";

    if(currentRole==="admin"){
      adminPanel.style.display="block";
    }

    listenUsers();
    listenMessages();
  });
}

/* ===== ONLINE USERS ===== */
function listenUsers(){
  db.ref("users").on("value",s=>{
    userList.innerHTML="";
    s.forEach(u=>{
      const d=document.createElement("div");
      const on=u.val().online?"online":"offline";
      d.className="user";
      d.innerHTML=`${u.key} <span class="${on}">‚óè</span>`;
      userList.appendChild(d);
    });
  });
}

/* ===== ADMIN ===== */
function deleteUser(){
  const u=searchUser.value.trim();
  if(!u||u===CONFIG.adminUsername) return;
  db.ref("users/"+u).remove();
}
function toggleAdmin(){
  const u=searchUser.value.trim();
  db.ref("users/"+u+"/role").get().then(s=>{
    const r=s.val()==="admin"?"user":"admin";
    db.ref("users/"+u+"/role").set(r);
  });
}

/* ===== CHAT ===== */
function sendMessage(){
  const t=msg.value.trim();
  if(!t) return;
  db.ref("messages").push({user:currentUser,text:t});
  msg.value="";
}

function listenMessages(){
  db.ref("messages").on("child_added",s=>{
    const m=s.val(), id=s.key;
    const d=document.createElement("div");
    d.className="msg";
    d.id=id;
    d.innerHTML=`<span>${m.user}: ${m.text}</span>`;

    if(m.user===currentUser||currentRole==="admin"){
      const tr=document.createElement("span");
      tr.className="trash";
      tr.innerText="üóëÔ∏è";
      tr.onclick=()=>db.ref("messages/"+id).remove();
      d.appendChild(tr);
    }
    messages.appendChild(d);
    messages.scrollTop=messages.scrollHeight;
  });

  db.ref("messages").on("child_removed",s=>{
    const el=document.getElementById(s.key);
    if(el) el.remove();
  });
}
</script>

</body>
</html>
