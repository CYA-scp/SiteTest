<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Private Pro Chat</title>

<style>
body{
  margin:0;background:#1e1f22;font-family:Arial;color:#dcddde;
  height:100vh;display:flex;justify-content:center;align-items:center
}
.login,.app{
  background:#313338;border-radius:8px;
}
.login{
  width:300px;padding:20px
}
.login input,.login button{
  width:100%;margin-top:8px;padding:8px
}
.login button{background:#5865f2;border:none;color:white}

.app{
  width:950px;height:540px;display:none;overflow:hidden
}
.sidebar{
  width:260px;background:#2b2d31;padding:10px
}
.user{padding:6px;border-radius:4px}
.online{color:#22c55e}
.offline{color:#ef4444}

.chat{flex:1;display:flex;flex-direction:column}
.messages{flex:1;padding:10px;overflow-y:auto}
.msg{margin-bottom:6px;display:flex;justify-content:space-between}
.trash{cursor:pointer;color:#ed4245}

.input{display:flex;padding:10px;background:#383a40}
.input input{flex:1;background:#1e1f22;border:none;color:white;padding:8px}
.input button{margin-left:8px;background:#5865f2;border:none;color:white}

.panel{
  border-top:1px solid #3f4147;
  margin-top:6px;padding-top:6px
}
.panel input,.panel button{
  width:100%;margin-top:6px;padding:6px
}
.red{background:#ed4245;color:white;border:none}
.green{background:#22c55e;border:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="login" id="loginBox">
  <h3>Login</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Daxil ol</button>
</div>

<!-- APP -->
<div class="app" id="app">

<div class="sidebar">
  <h4>Users</h4>
  <div id="userList"></div>

  <!-- SETTINGS -->
  <div class="panel">
    <input id="tagInput" placeholder="Tag (max 10)">
    <button onclick="saveTag()">Tag saxla</button>

    <input id="newPass" placeholder="Yeni ≈üifr…ô">
    <button onclick="changePassword()">≈ûifr…ô d…ôyi≈ü</button>

    <button class="red" onclick="logout()">Hesabdan √ßƒ±x</button>
  </div>

  <!-- ADMIN -->
  <div class="panel" id="adminPanel" style="display:none">
    <input id="newUser" placeholder="Yeni username">
    <input id="newUserPass" placeholder="Yeni ≈üifr…ô">
    <button class="green" onclick="addUser()">User …ôlav…ô et</button>

    <input id="targetUser" placeholder="User adƒ±">
    <button class="red" onclick="deleteUser()">User sil</button>
  </div>

  <!-- ADMIN VIEW -->
  <div class="panel" id="adminView" style="display:none"></div>
</div>

<div class="chat">
  <div class="messages" id="messages"></div>
  <div class="input">
    <input id="msg" placeholder="Mesaj yaz..."
      onkeydown="if(event.key==='Enter')sendMessage()">
    <button onclick="sendMessage()">G√∂nd…ôr</button>
  </div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const CONFIG={
  firebase:{
    apiKey:"AIzaSyC4t6Cu-q8iIHGy3V5g-Q14s3qnwsnfRKU",
    databaseURL:"https://projectchat-bcb6e-default-rtdb.firebaseio.com"
  }
};
firebase.initializeApp(CONFIG.firebase);
const db=firebase.database();

let currentUser="", currentRole="user";

/* LOGIN */
function login(){
  const u=username.value.trim(), p=password.value.trim();
  db.ref("users/"+u).get().then(s=>{
    if(!s.exists()) return alert("User yoxdur");
    if(s.val().deleted) return alert("Hesabƒ±n silinib ‚ùå");
    if(s.val().password!==p) return alert("Parol s…ôhv");

    currentUser=u;
    currentRole=s.val().role;
    db.ref("users/"+u+"/online").set(true);

    window.addEventListener("beforeunload",()=>logout(true));

    loginBox.style.display="none";
    app.style.display="flex";

    if(currentRole==="admin"){
      adminPanel.style.display="block";
      adminView.style.display="block";
    }

    listenUsers();
    listenMessages();
    adminPasswords();
  });
}

/* LOGOUT */
function logout(silent){
  if(currentUser){
    db.ref("users/"+currentUser+"/online").set(false);
  }
  if(!silent) location.reload();
}

/* USERS LIST */
function listenUsers(){
  db.ref("users").on("value",s=>{
    userList.innerHTML="";
    s.forEach(u=>{
      if(u.val().deleted) return;
      const tag=u.val().tag?` (${u.val().tag})`:"";
      const on=u.val().online?"online":"offline";
      const d=document.createElement("div");
      d.className="user";
      d.innerHTML=`${u.key}${tag} <span class="${on}">‚óè</span>`;
      userList.appendChild(d);
    });
  });
}

/* TAG */
function saveTag(){
  const t=tagInput.value.trim().slice(0,10);
  db.ref("users/"+currentUser+"/tag").set(t);
}

/* PASSWORD */
function changePassword(){
  const p=newPass.value.trim();
  if(p) db.ref("users/"+currentUser+"/password").set(p);
}

/* ADMIN ADD USER */
function addUser(){
  db.ref("users/"+newUser.value).set({
    password:newUserPass.value,
    role:"user",
    online:false,
    deleted:false,
    tag:""
  });
}

/* ADMIN DELETE USER */
function deleteUser(){
  const u=targetUser.value.trim();
  if(!u||u===currentUser) return;
  db.ref("users/"+u+"/deleted").set(true);
  db.ref("system").push({text:`${u} hesabƒ± silindi`});
}

/* ADMIN VIEW PASSWORDS */
function adminPasswords(){
  if(currentRole!=="admin") return;
  db.ref("users").on("value",s=>{
    adminView.innerHTML="<h4>Hesablar</h4>";
    s.forEach(u=>{
      adminView.innerHTML+=
        `<div>${u.key} | ${u.val().password}</div>`;
    });
  });
}

/* CHAT */
function sendMessage(){
  const t=msg.value.trim();
  if(!t) return;
  db.ref("messages").push({user:currentUser,text:t});
  msg.value="";
}

function listenMessages(){
  db.ref("messages").on("child_added",s=>{
    const m=s.val(), id=s.key;
    const d=document.createElement("div");
    d.className="msg";
    d.id=id;
    d.innerHTML=`<span>${m.user}: ${m.text}</span>`;
    if(m.user===currentUser||currentRole==="admin"){
      const tr=document.createElement("span");
      tr.className="trash";
      tr.innerText="üóëÔ∏è";
      tr.onclick=()=>db.ref("messages/"+id).remove();
      d.appendChild(tr);
    }
    messages.appendChild(d);
    messages.scrollTop=messages.scrollHeight;
  });
}
</script>

</body>
</html>
