<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Private Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
#login,#chat{display:none}
.box{width:380px;margin:60px auto;background:#020617;padding:20px;border-radius:10px}
input,button{width:100%;margin-top:8px;padding:8px;border-radius:6px;border:none}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.err{color:#f87171;font-size:13px}
#chatBox{height:300px;overflow-y:auto;border:1px solid #1e293b;padding:10px;margin-top:10px}
.msg{display:flex;gap:8px;margin-bottom:8px}
.msg img{width:32px;height:32px;border-radius:50%}
.del{color:#ef4444;cursor:pointer;margin-left:6px}
#side{position:fixed;left:0;top:0;width:180px;height:100%;background:#020617;padding:10px}
.userItem{font-size:14px}
.admin{color:#facc15}
</style>
</head>

<body>

<div id="side">
<h4>Online</h4>
<div id="online"></div>
<button onclick="logout()">√áƒ±xƒ±≈ü</button>
<div id="adminPanel"></div>
</div>

<div id="login" class="box">
<h3>Login</h3>
<input id="lu" placeholder="Username">
<input id="lp" type="password" placeholder="Password">
<div id="lerr" class="err"></div>
<button onclick="login()">Daxil ol</button>
</div>

<div id="chat" class="box">
<h3 id="welcome"></h3>
<div id="chatBox"></div>
<input id="msg" placeholder="Mesaj yaz">
<button onclick="sendMessage()">G√∂nd…ôr</button>
</div>

<script>
const firebaseConfig={
  apiKey:"AIzaSyC4t6Cu-q8iIHGy3V5g-Q14s3qnwsnfRKU",
  databaseURL:"https://projectchat-bcb6e-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let user="", role="", tries=3, cooldown=false;

function show(id){
  login.style.display="none";
  chat.style.display="none";
  document.getElementById(id).style.display="block";
}

// ===== LOGIN =====
function login(){
  if(cooldown) return;
  const u=lu.value.trim();
  const p=lp.value;
  lerr.textContent="";

  db.ref("users/"+u).get().then(s=>{
    if(!s.exists()){
      lerr.textContent="User yoxdur";
      return;
    }
    if(s.val().password!==p){
      tries--;
      if(tries<=0){
        cooldown=true;
        lerr.textContent="20 saniy…ô g√∂zl…ô";
        setTimeout(()=>{
          tries=3; cooldown=false; lerr.textContent="";
        },20000);
      } else lerr.textContent="≈ûifr…ô s…ôhv";
      return;
    }

    user=u;
    role=s.val().role;
    localStorage.user=u;
    db.ref("online/"+u).set(true);
    start();
  });
}

// ===== START =====
function start(){
  show("chat");
  welcome.innerText="Xo≈ü g…ôldin "+user;
  listenMessages();
  listenOnline();
  if(role==="admin") adminUI();
}

// ===== LOGOUT =====
function logout(){
  db.ref("online/"+user).remove();
  localStorage.clear();
  location.reload();
}

// ===== AUTO LOGIN FIX =====
if(localStorage.user){
  user=localStorage.user;
  db.ref("users/"+user).get().then(s=>{
    if(!s.exists()){
      localStorage.clear();
      show("login");
      return;
    }
    role=s.val().role;
    db.ref("online/"+user).set(true);
    start();
  });
} else {
  show("login");
}

// ===== SEND MESSAGE =====
function sendMessage(){
  if(!msg.value.trim()) return;
  const id=db.ref("messages").push().key;
  db.ref("messages/"+id).set({
    id:id,
    user:user,
    text:msg.value
  });
  msg.value="";
}

// ===== LISTEN MESSAGE =====
function listenMessages(){
  chatBox.innerHTML="";
  db.ref("messages").on("child_added",s=>{
    const m=s.val();
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML=`
      <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${m.user}">
      <div>
        <b>${m.user}</b>
        ${(role==="admin"||m.user===user)?`<span class="del" onclick="delMsg('${m.id}')">üóëÔ∏è</span>`:""}
        <div>${m.text}</div>
      </div>
    `;
    chatBox.appendChild(d);
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

// ===== DELETE MESSAGE =====
function delMsg(id){
  db.ref("messages/"+id).get().then(s=>{
    if(!s.exists()) return;
    if(role==="admin"||s.val().user===user)
      db.ref("messages/"+id).remove();
  });
}

// ===== ONLINE =====
function listenOnline(){
  db.ref("online").on("value",s=>{
    online.innerHTML="";
    s.forEach(c=>{
      online.innerHTML+=`<div class="userItem">${c.key}</div>`;
    });
  });
}

// ===== ADMIN PANEL =====
function adminUI(){
  adminPanel.innerHTML=`
    <h4>Admin</h4>
    <input id="au" placeholder="Username">
    <input id="ap" placeholder="Password">
    <button onclick="addUser()">User …ôlav…ô et</button>
    <button onclick="makeAdmin()">Admin et</button>
  `;
}

function addUser(){
  if(!au.value||!ap.value) return;
  db.ref("users/"+au.value).set({password:ap.value,role:"user"});
}

function makeAdmin(){
  if(!au.value) return;
  db.ref("users/"+au.value+"/role").set("admin");
}
</script>

</body>
</html>
